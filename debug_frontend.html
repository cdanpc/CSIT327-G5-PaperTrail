<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forum API Frontend Debugger</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      line-height: 1.6;
    }
    .section {
      background: #252526;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 20px;
    }
    h2 {
      color: #4ec9b0;
      margin-top: 0;
    }
    .test-button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    .test-button:hover {
      background: #1177bb;
    }
    .output {
      background: #1e1e1e;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      padding: 15px;
      margin-top: 10px;
      white-space: pre-wrap;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      color: #4ec9b0;
    }
    .error {
      color: #f48771;
    }
    .info {
      color: #9cdcfe;
    }
    .warning {
      color: #dcdcaa;
    }
  </style>
</head>
<body>
  <h1>üîß Forum API Frontend Debugger</h1>
  
  <div class="section">
    <h2>Test 1: Basic Fetch Request</h2>
    <p>Tests the raw fetch() call to the topics API endpoint</p>
    <button class="test-button" onclick="test1()">Run Test 1</button>
    <div id="output1" class="output"></div>
  </div>

  <div class="section">
    <h2>Test 2: Full ForumApp.loadTopics()</h2>
    <p>Tests the actual loadTopics() method from forum.js</p>
    <button class="test-button" onclick="test2()">Run Test 2</button>
    <div id="output2" class="output"></div>
  </div>

  <div class="section">
    <h2>Test 3: Network Inspection</h2>
    <p>Analyzes the response headers, timing, and payload structure</p>
    <button class="test-button" onclick="test3()">Run Test 3</button>
    <div id="output3" class="output"></div>
  </div>

  <div class="section">
    <h2>Test 4: Authentication Check</h2>
    <p>Verifies authentication state and session cookies</p>
    <button class="test-button" onclick="test4()">Run Test 4</button>
    <div id="output4" class="output"></div>
  </div>

  <div class="section">
    <h2>Test 5: Live Rendering Test</h2>
    <p>Actually renders the topics on this page to verify DOM manipulation</p>
    <button class="test-button" onclick="test5()">Run Test 5</button>
    <div id="renderContainer" style="margin-top: 15px; border: 1px dashed #3c3c3c; padding: 15px; min-height: 100px;"></div>
    <div id="output5" class="output"></div>
  </div>

  <script>
    function log(outputId, message, type = 'info') {
      const output = document.getElementById(outputId);
      const className = type;
      const timestamp = new Date().toLocaleTimeString();
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
    }

    function clear(outputId) {
      document.getElementById(outputId).innerHTML = '';
    }

    // Test 1: Basic Fetch
    async function test1() {
      clear('output1');
      log('output1', 'üöÄ Starting Test 1: Basic Fetch Request', 'info');
      
      try {
        log('output1', '‚Üí Fetching /forum/api/topics/', 'info');
        const startTime = performance.now();
        
        const response = await fetch('/forum/api/topics/', {
          method: 'GET',
          credentials: 'include', // Include cookies for authentication
          headers: {
            'Accept': 'application/json'
          }
        });
        
        const endTime = performance.now();
        const duration = (endTime - startTime).toFixed(2);
        
        log('output1', `‚úì Response received in ${duration}ms`, 'success');
        log('output1', `  Status: ${response.status} ${response.statusText}`, 
            response.ok ? 'success' : 'error');
        log('output1', `  Content-Type: ${response.headers.get('Content-Type')}`, 'info');
        log('output1', `  Response.ok: ${response.ok}`, response.ok ? 'success' : 'error');
        
        const data = await response.json();
        log('output1', `\nüì¶ Response Data:`, 'info');
        log('output1', JSON.stringify(data, null, 2), 'info');
        
        if (data.success) {
          log('output1', `\n‚úÖ SUCCESS: Retrieved ${data.total_topics} topics`, 'success');
        } else {
          log('output1', `\n‚ùå FAILURE: ${data.error}`, 'error');
          if (data.redirect) {
            log('output1', `   Redirect URL: ${data.redirect}`, 'warning');
          }
        }
        
      } catch (error) {
        log('output1', `\n‚ùå ERROR: ${error.message}`, 'error');
        log('output1', `   Stack: ${error.stack}`, 'error');
      }
    }

    // Test 2: ForumApp.loadTopics() simulation
    async function test2() {
      clear('output2');
      log('output2', 'üöÄ Starting Test 2: Simulated loadTopics()', 'info');
      
      const ForumApp = {
        showError(container, message) {
          log('output2', `‚ùå showError() called: ${message}`, 'error');
        },
        
        async loadTopics() {
          log('output2', '‚Üí Calling loadTopics() method', 'info');
          
          try {
            const response = await fetch('/forum/api/topics/');
            log('output2', `  API Response status: ${response.status}`, 
                response.ok ? 'success' : 'error');
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            log('output2', `  Topics data received: ${JSON.stringify(data)}`, 'info');

            // Handle authentication error
            if (!data.success && response.status === 401) {
              this.showError(null, 'Please log in to view forum topics.');
              if (data.redirect) {
                log('output2', `  Would redirect to: ${data.redirect}`, 'warning');
              }
              return;
            }

            if (data.success && Array.isArray(data.topics)) {
              if (data.topics.length === 0) {
                log('output2', '‚ö† No topics available', 'warning');
                return;
              }

              log('output2', `‚úÖ Successfully loaded ${data.topics.length} topics`, 'success');
              log('output2', '\nüìã Topics list:', 'info');
              data.topics.forEach((topic, idx) => {
                log('output2', `  ${idx + 1}. ${topic.name} (${topic.thread_count} threads)`, 'info');
              });
            } else {
              const errorMsg = data.error || 'Failed to load topics';
              log('output2', `‚ùå API returned error: ${errorMsg}`, 'error');
              this.showError(null, errorMsg);
            }
          } catch (error) {
            log('output2', `‚ùå Error loading topics: ${error.message}`, 'error');
            this.showError(null, `Network error: ${error.message}`);
          }
        }
      };
      
      await ForumApp.loadTopics();
    }

    // Test 3: Network Inspection
    async function test3() {
      clear('output3');
      log('output3', 'üöÄ Starting Test 3: Network Inspection', 'info');
      
      try {
        const startTime = performance.now();
        const response = await fetch('/forum/api/topics/', {
          credentials: 'include'
        });
        const endTime = performance.now();
        
        log('output3', 'üìä Response Analysis:', 'info');
        log('output3', `  Total Time: ${(endTime - startTime).toFixed(2)}ms`, 'info');
        log('output3', `  Status: ${response.status} ${response.statusText}`, 
            response.ok ? 'success' : 'error');
        log('output3', `  Type: ${response.type}`, 'info');
        log('output3', `  Redirected: ${response.redirected}`, 'info');
        
        log('output3', '\nüìù Response Headers:', 'info');
        for (const [key, value] of response.headers.entries()) {
          log('output3', `  ${key}: ${value}`, 'info');
        }
        
        const text = await response.text();
        log('output3', `\nüì¶ Response Size: ${text.length} bytes`, 'info');
        
        try {
          const data = JSON.parse(text);
          log('output3', `‚úì Valid JSON response`, 'success');
          log('output3', `  Keys: ${Object.keys(data).join(', ')}`, 'info');
        } catch (e) {
          log('output3', `‚ùå Invalid JSON response`, 'error');
          log('output3', `  Preview: ${text.substring(0, 200)}...`, 'error');
        }
        
      } catch (error) {
        log('output3', `‚ùå ERROR: ${error.message}`, 'error');
      }
    }

    // Test 4: Authentication Check
    async function test4() {
      clear('output4');
      log('output4', 'üöÄ Starting Test 4: Authentication Check', 'info');
      
      // Check cookies
      log('output4', 'üç™ Cookies:', 'info');
      const cookies = document.cookie.split(';').map(c => c.trim());
      if (cookies.length === 0 || cookies[0] === '') {
        log('output4', '  ‚ö† No cookies found!', 'warning');
      } else {
        cookies.forEach(cookie => {
          const [name, value] = cookie.split('=');
          if (name === 'csrftoken' || name === 'sessionid') {
            log('output4', `  ‚úì ${name}: ${value.substring(0, 20)}...`, 'success');
          } else {
            log('output4', `  ${name}: ${value.substring(0, 20)}...`, 'info');
          }
        });
      }
      
      // Check session via API
      log('output4', '\nüë§ Session Check:', 'info');
      try {
        const response = await fetch('/forum/api/topics/');
        const data = await response.json();
        
        if (response.status === 401 || !data.success) {
          log('output4', '  ‚ùå NOT AUTHENTICATED', 'error');
          if (data.error) {
            log('output4', `     Error: ${data.error}`, 'error');
          }
        } else {
          log('output4', '  ‚úÖ AUTHENTICATED', 'success');
          log('output4', `     Can access ${data.total_topics} topics`, 'success');
        }
      } catch (error) {
        log('output4', `  ‚ùå Error checking auth: ${error.message}`, 'error');
      }
    }

    // Test 5: Live Rendering
    async function test5() {
      clear('output5');
      const container = document.getElementById('renderContainer');
      container.innerHTML = '<p style="color: #9cdcfe;">Loading topics...</p>';
      
      log('output5', 'üöÄ Starting Test 5: Live Rendering', 'info');
      
      try {
        const response = await fetch('/forum/api/topics/');
        log('output5', `  Response: ${response.status}`, response.ok ? 'success' : 'error');
        
        const data = await response.json();
        
        if (data.success && Array.isArray(data.topics)) {
          log('output5', `‚úì Rendering ${data.topics.length} topics to DOM`, 'success');
          
          container.innerHTML = data.topics.map(topic => `
            <div style="background: #2d2d30; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 3px solid #4ec9b0;">
              <h3 style="margin: 0 0 5px 0; color: #4ec9b0;">${topic.name}</h3>
              <p style="margin: 5px 0; color: #9cdcfe; font-size: 13px;">${topic.description}</p>
              <p style="margin: 5px 0; color: #808080; font-size: 12px;">
                <i>üí¨ ${topic.thread_count} ${topic.thread_count === 1 ? 'thread' : 'threads'}</i>
              </p>
            </div>
          `).join('');
          
          log('output5', '‚úÖ Rendering complete!', 'success');
        } else {
          container.innerHTML = `<p style="color: #f48771;">‚ùå ${data.error || 'Failed to load topics'}</p>`;
          log('output5', `‚ùå Error: ${data.error || 'Unknown error'}`, 'error');
        }
        
      } catch (error) {
        container.innerHTML = `<p style="color: #f48771;">‚ùå Error: ${error.message}</p>`;
        log('output5', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Auto-run Test 1 on page load
    window.addEventListener('DOMContentLoaded', () => {
      log('output1', 'üîç Page loaded - Click "Run Test 1" to start debugging', 'info');
    });
  </script>
</body>
</html>
