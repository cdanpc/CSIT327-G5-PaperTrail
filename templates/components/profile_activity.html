{% comment %}
Profile Activity Component
Displays recent activity feed for all user roles
{% endcomment %}

<div class="profile-card activity-card">
    <div class="profile-card-header">
        <h3 class="profile-card-title">
            <i class="fas fa-clock"></i> Recent Activity
        </h3>
    </div>
    
    <div class="profile-card-body">
        {% if activities %}
        <div class="activity-timeline">
            {% for activity in activities %}
            <div class="activity-item">
                <div class="activity-icon activity-icon--{{ activity.type }}">
                    {% if activity.type == 'resource' %}
                    <i class="fas fa-file-upload"></i>
                    {% elif activity.type == 'quiz' %}
                    <i class="fas fa-question-circle"></i>
                    {% elif activity.type == 'flashcard' %}
                    <i class="fas fa-layer-group"></i>
                    {% elif activity.type == 'comment' %}
                    <i class="fas fa-comment"></i>
                    {% elif activity.type == 'like' %}
                    <i class="fas fa-heart"></i>
                    {% elif activity.type == 'bookmark' %}
                    <i class="fas fa-bookmark"></i>
                    {% else %}
                    <i class="fas fa-circle"></i>
                    {% endif %}
                </div>
                
                <div class="activity-content">
                    <div class="activity-description">
                        {% if activity.type == 'resource' %}
                        <span class="activity-action">Uploaded a resource</span>
                        <a href="{% url 'resources:resource_detail' activity.object_id %}" class="activity-target">
                            {{ activity.title }}
                        </a>
                        
                        {% elif activity.type == 'quiz' %}
                        <span class="activity-action">
                            {% if activity.action == 'created' %}
                            Created a quiz
                            {% else %}
                            Completed a quiz
                            {% endif %}
                        </span>
                        <a href="{% url 'quizzes:quiz_detail' activity.object_id %}" class="activity-target">
                            {{ activity.title }}
                        </a>
                        
                        {% elif activity.type == 'flashcard' %}
                        <span class="activity-action">
                            {% if activity.action == 'created' %}
                            Created a flashcard set
                            {% else %}
                            Practiced flashcards
                            {% endif %}
                        </span>
                        <a href="{% url 'flashcards:deck_detail' activity.object_id %}" class="activity-target">
                            {{ activity.title }}
                        </a>
                        
                        {% elif activity.type == 'comment' %}
                        <span class="activity-action">Commented on</span>
                        <a href="{{ activity.url }}" class="activity-target">
                            {{ activity.target_title }}
                        </a>
                        
                        {% elif activity.type == 'like' %}
                        <span class="activity-action">Liked</span>
                        <a href="{{ activity.url }}" class="activity-target">
                            {{ activity.target_title }}
                        </a>
                        
                        {% elif activity.type == 'bookmark' %}
                        <span class="activity-action">Bookmarked</span>
                        <a href="{{ activity.url }}" class="activity-target">
                            {{ activity.target_title }}
                        </a>
                        
                        {% else %}
                        <span class="activity-action">{{ activity.description }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="activity-meta">
                        <span class="activity-time">
                            <i class="far fa-clock"></i>
                            {{ activity.timestamp|timesince }} ago
                        </span>
                        {% if activity.visibility %}
                        <span class="activity-visibility">
                            {% if activity.visibility == 'public' %}
                            <i class="fas fa-globe"></i> Public
                            {% elif activity.visibility == 'private' %}
                            <i class="fas fa-lock"></i> Private
                            {% endif %}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if has_more_activities %}
        <div class="activity-footer">
            <button class="btn-load-more" onclick="loadMoreActivities()">
                Load More <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>
                {% if is_own_profile %}
                No recent activity. Start exploring resources!
                {% else %}
                This user has no recent activity.
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<script>
let activityPage = 2;
let loadingActivities = false;

async function loadMoreActivities() {
    if (loadingActivities) return;
    
    loadingActivities = true;
    const loadMoreBtn = document.querySelector('.btn-load-more');
    const originalText = loadMoreBtn.innerHTML;
    loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    loadMoreBtn.disabled = true;
    
    try {
        const response = await fetch(`${window.location.href}?activities_page=${activityPage}&ajax=1`);
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.activities && data.activities.length > 0) {
                const timeline = document.querySelector('.activity-timeline');
                
                // Append new activities
                data.activities.forEach(activity => {
                    const activityHTML = createActivityHTML(activity);
                    timeline.insertAdjacentHTML('beforeend', activityHTML);
                });
                
                activityPage++;
                
                // Hide load more button if no more activities
                if (!data.has_more) {
                    loadMoreBtn.style.display = 'none';
                }
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error loading activities:', error);
        alert('Failed to load more activities');
    } finally {
        loadMoreBtn.innerHTML = originalText;
        loadMoreBtn.disabled = false;
        loadingActivities = false;
    }
}

function createActivityHTML(activity) {
    // Helper function to create activity item HTML
    // This would need to match your activity structure
    return `
        <div class="activity-item">
            <div class="activity-icon activity-icon--${activity.type}">
                <i class="fas fa-${getActivityIcon(activity.type)}"></i>
            </div>
            <div class="activity-content">
                <div class="activity-description">
                    <span class="activity-action">${activity.action}</span>
                    <a href="${activity.url}" class="activity-target">${activity.title}</a>
                </div>
                <div class="activity-meta">
                    <span class="activity-time">
                        <i class="far fa-clock"></i> ${activity.time_ago}
                    </span>
                </div>
            </div>
        </div>
    `;
}

function getActivityIcon(type) {
    const icons = {
        'resource': 'file-upload',
        'quiz': 'question-circle',
        'flashcard': 'layer-group',
        'comment': 'comment',
        'like': 'heart',
        'bookmark': 'bookmark'
    };
    return icons[type] || 'circle';
}
</script>
