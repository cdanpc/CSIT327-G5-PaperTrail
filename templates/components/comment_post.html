{% load time_filters %}
{% comment %}
  Comment Post Component
  
  Purpose: Displays a single user-submitted comment/reply
  Reusable for: All content types with threaded comment support
  
  Required Context Variables:
    - comment: Comment object with attributes:
        - pk: Primary key
        - user: User object with get_display_name method
        - created_at: DateTime
        - text: Comment text
        - is_owner_comment: Boolean method
        - replies: Related manager (if show_replies is True)
    - delete_url_name: URL name for comment deletion
    - current_user: Current logged-in user
    - show_replies: Boolean to show nested replies (default: False)
    - is_reply: Boolean indicating if this is a reply (affects styling)
{% endcomment %}

<div class="{% if is_reply %}ms-5 mt-3 border-start ps-3{% else %}border-bottom pb-3 mb-3{% endif %}" data-comment-id="{{ comment.pk }}">
  <div class="d-flex justify-content-between align-items-start">
    <div class="d-flex gap-3 flex-grow-1">
      <a href="{% url 'accounts:public_profile' comment.user.username %}" class="comment-avatar-link">
        {% if comment.user.profile_picture %}
          <img src="{{ comment.user.profile_picture.url }}" class="comment-user-avatar {% if is_reply %}avatar-32{% else %}avatar-40{% endif %}" alt="{{ comment.user.get_display_name }}">
        {% else %}
          <div class="avatar-circle {% if is_reply %}avatar-32{% else %}avatar-40{% endif %}">
            <span class="text-white small fw-bold">{{ comment.user.get_display_name|first|upper }}</span>
          </div>
        {% endif %}
      </a>
      <div class="flex-grow-1">
        <div class="d-flex align-items-center gap-2 mb-1">
          <a href="{% url 'accounts:public_profile' comment.user.username %}" class="comment-user-link">
            <strong class="title-strong">{{ comment.user.get_display_name }}</strong>
          </a>
          {% if comment.is_owner_comment %}
            <span class="badge badge-warning badge-sm"><i class="fas fa-crown"></i> Owner</span>
          {% elif comment.user.is_professor %}
            <span class="badge badge-professor badge-sm">Professor</span>
          {% endif %}
        </div>
        <div class="comment-text" data-comment-id="{{ comment.pk }}">
          <p class="{% if is_reply %}mb-1{% else %}mb-2{% endif %} para-muted lh-16">{{ comment.text }}</p>
        </div>
        <textarea class="form-control comment-edit-textarea d-none" data-comment-id="{{ comment.pk }}" rows="3">{{ comment.text }}</textarea>
        <div class="d-flex align-items-center gap-3 mb-2">
          <small class="text-muted" data-timestamp="{{ comment.created_at|date:'c' }}">{{ comment.created_at|short_timesince }}</small>
          <button type="button" class="reply-btn-text" data-comment-id="{{ comment.pk }}" data-author="{{ comment.user.get_display_name }}">
            Reply
          </button>
        </div>

        <!-- Reply Form (Hidden) -->
        <div class="reply-form-container d-none mt-2" data-comment-id="{{ comment.pk }}">
            <div class="d-flex gap-3">
                {% if current_user.profile_picture %}
                    <img src="{{ current_user.profile_picture.url }}" class="comment-user-avatar avatar-32" alt="{{ current_user.get_display_name }}">
                {% else %}
                    <div class="avatar-circle avatar-32">
                        <span class="text-white small fw-bold">{{ current_user.get_display_name|first|upper }}</span>
                    </div>
                {% endif %}
                <div class="flex-grow-1">
                    <form method="post" action="{{ comment_url }}" class="reply-form">
                        {% csrf_token %}
                        <input type="hidden" name="parent_comment_id" value="{{ comment.pk }}">
                        <textarea name="text" class="form-control mb-2" rows="2" placeholder="Add a reply..."></textarea>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-sm btn-secondary reply-cancel-btn" data-comment-id="{{ comment.pk }}">Cancel</button>
                            <button type="submit" class="btn btn-sm btn-primary">Reply</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="comment-actions-row">
          <button type="button" class="btn btn-sm btn-success comment-save-btn d-none" data-comment-id="{{ comment.pk }}">
            <i class="fas fa-check"></i> Save
          </button>
          <button type="button" class="btn btn-sm btn-secondary comment-cancel-btn d-none" data-comment-id="{{ comment.pk }}">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>
    {% if comment.user == current_user %}
    <div class="dropdown comment-dropdown">
      <button class="btn btn-sm btn-link comment-options-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-ellipsis-v"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li>
          <a class="dropdown-item comment-edit-btn" href="#" data-comment-id="{{ comment.pk }}">
            <i class="fas fa-edit"></i> Edit
          </a>
        </li>
        <li>
          <a class="dropdown-item text-danger comment-delete-btn" href="#" data-comment-id="{{ comment.pk }}" data-delete-url="{% url delete_url_name comment.pk %}">
            <i class="fas fa-trash"></i> Delete
          </a>
        </li>
      </ul>
    </div>
    {% endif %}
  </div>
  
  {# Show nested replies if enabled #}
  {% if show_replies and comment.replies.all %}
    {% for reply in comment.replies.all %}
      {% include 'components/comment_post.html' with comment=reply delete_url_name=delete_url_name current_user=current_user is_reply=True show_replies=True comment_url=comment_url %}
    {% endfor %}
  {% endif %}
</div>
