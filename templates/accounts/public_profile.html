{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}{{ profile_user.get_full_name|default:profile_user.username }}'s Profile - PaperTrail{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile_style.css' %}?v=5.0">
<link rel="stylesheet" href="{% static 'css/components.css' %}?v=1.0">
{% endblock %}

{% block header %}
{% url 'accounts:dashboard' as dashboard_url %}
{% include 'components/page_header.html' with page_title=profile_user.get_full_name|default:profile_user.username back_url=dashboard_url show_moderate_btn=False %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Profile Content -->
        <div class="col-lg-8 offset-lg-2">
            <!-- Profile Header Card -->
            <div class="profile-card profile-header-card mb-4">
                <div class="profile-header-content">
                    <!-- Profile Photo (no edit overlay for public view) -->
                    <div class="profile-photo-wrapper">
                        <img src="{% if profile_user.profile_picture %}{{ profile_user.profile_picture.url }}{% else %}https://ui-avatars.com/api/?name={{ profile_user.first_name }}+{{ profile_user.last_name }}&size=150&background=667eea&color=fff{% endif %}" 
                             alt="{{ profile_user.get_full_name }}'s Profile Photo" 
                             class="profile-photo-xl">
                    </div>
                    
                    <!-- User Info -->
                    <div class="profile-identity">
                        <h2 class="profile-name">{{ profile_user.get_full_name|default:profile_user.username }}</h2>
                        <span class="profile-role-badge">
                            {% if profile_user.is_staff or profile_user.is_superuser %}
                            <i class="fas fa-crown"></i> Admin
                            {% elif profile_user.is_professor %}
                            <i class="fas fa-chalkboard-teacher"></i> Professor
                            {% else %}
                            <i class="fas fa-user-graduate"></i> Student
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Profile Information Card -->
            <div class="profile-card">
                <div class="card-header-row">
                    <h3 class="card-title">
                        <i class="fas fa-user"></i>
                        Profile Information
                    </h3>
                </div>

                <!-- Tab Navigation -->
                <div class="profile-tabs-nav">
                    <button class="profile-tab-btn active" data-tab="personal" onclick="switchTab('personal')">
                        <i class="fas fa-user"></i>
                        <span>Personal Info</span>
                    </button>
                    <button class="profile-tab-btn" data-tab="academic" onclick="switchTab('academic')">
                        <i class="fas fa-university"></i>
                        <span>Academic Info</span>
                    </button>
                    <button class="profile-tab-btn" data-tab="about" onclick="switchTab('about')">
                        <i class="fas fa-edit"></i>
                        <span>About Me</span>
                    </button>
                </div>

                <!-- Tab Panels -->
                <div class="profile-tabs-content">
                    <!-- Personal Info Tab -->
                    <div class="profile-tab-panel active" id="personal-tab">
                        <div class="tab-panel-header">
                            <h3 class="tab-panel-title">Personal Information</h3>
                            <!-- No edit button for public view -->
                        </div>

                        <!-- Display Mode Only -->
                        <div class="info-display-grid">
                            <div class="info-field">
                                <label class="info-field-label">First Name</label>
                                <div class="info-field-value {% if not profile_user.first_name %}empty{% endif %}">
                                    {{ profile_user.first_name|default:"Not provided" }}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Last Name</label>
                                <div class="info-field-value {% if not profile_user.last_name %}empty{% endif %}">
                                    {{ profile_user.last_name|default:"Not provided" }}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Personal Email</label>
                                <div class="info-field-value {% if not profile_user.personal_email %}empty{% endif %}">
                                    {{ profile_user.personal_email|default:"Not provided" }}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Phone Number</label>
                                <div class="info-field-value {% if not profile_user.phone %}empty{% endif %}">
                                    {{ profile_user.phone|default:"Not provided" }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Info Tab -->
                    <div class="profile-tab-panel" id="academic-tab">
                        <div class="tab-panel-header">
                            <h3 class="tab-panel-title">Academic Information</h3>
                            <!-- No edit button for public view -->
                        </div>

                        <!-- Display Mode Only -->
                        <div class="info-display-grid">
                            <div class="info-field">
                                <label class="info-field-label">University Email</label>
                                <div class="info-field-value">
                                    {{ profile_user.univ_email }}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Student ID</label>
                                <div class="info-field-value">
                                    {{ profile_user.stud_id }}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Course</label>
                                <div class="info-field-value {% if not profile_user.course %}empty{% endif %}">
                                    {% if profile_user.course %}
                                        {% if profile_user.course == 'BSCS' %}Bachelor of Science in Computer Science
                                        {% elif profile_user.course == 'BSIT' %}Bachelor of Science in Information Technology
                                        {% elif profile_user.course == 'BSCE' %}Bachelor of Science in Computer Engineering
                                        {% elif profile_user.course == 'BSIS' %}Bachelor of Science in Information Systems
                                        {% elif profile_user.course == 'ACT' %}Associate in Computer Technology
                                        {% else %}{{ profile_user.course }}
                                        {% endif %}
                                    {% else %}Not provided{% endif %}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Year Level</label>
                                <div class="info-field-value {% if not profile_user.year_level %}empty{% endif %}">
                                    {% if profile_user.year_level %}{{ profile_user.year_level }}{% if profile_user.year_level == '1' %}st{% elif profile_user.year_level == '2' %}nd{% elif profile_user.year_level == '3' %}rd{% else %}th{% endif %} Year{% else %}Not provided{% endif %}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Department</label>
                                <div class="info-field-value {% if not profile_user.department %}empty{% endif %}">
                                    {{ profile_user.department|default:"Not provided" }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- About Me Tab -->
                    <div class="profile-tab-panel" id="about-tab">
                        <div class="tab-panel-header">
                            <h3 class="tab-panel-title">About Me</h3>
                            <!-- No edit button for public view -->
                        </div>

                        <!-- Display Mode Only -->
                        <div>
                            <div class="info-field">
                                <label class="info-field-label">Bio</label>
                                <div class="info-field-value bio-text {% if not profile_user.bio %}empty{% endif %}">
                                    {% if profile_user.bio %}
                                        {{ profile_user.bio|linebreaks }}
                                    {% else %}
                                        This user hasn't added a bio yet.
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verified Uploads Section -->
            <div class="profile-card mt-4">
                <div class="card-header-row">
                    <h3 class="card-title">
                        <i class="fas fa-check-circle"></i>
                        Verified Uploads
                    </h3>
                    <div class="filter-dropdown">
                        <select class="form-control" id="uploadFilter" onchange="filterUploads(this.value)">
                            <option value="all">All Uploads</option>
                            <option value="resources">Resources</option>
                            <option value="flashcards">Flashcards</option>
                            <option value="quizzes">Quizzes</option>
                        </select>
                    </div>
                </div>

                <div class="profile-card-body">
                    <!-- Upload items will be displayed here -->
                    <div id="uploads-container">
                        {% if user_resources or user_quizzes or user_decks %}
                        <div class="row g-3">
                            <!-- Resources -->
                            {% for resource in user_resources %}
                            <div class="col-md-6 col-lg-4" data-upload-type="resources">
                                <a href="{% url 'resources:resource_detail' resource.pk %}" class="study-card study-card--clickable">
                                    <div class="study-card__header">
                                        <div class="study-card__header-left">
                                            <span class="study-card__type">Resource</span>
                                            {% if resource.verification_status == 'verified' %}
                                            <span class="study-card__tag study-card__tag--verified"><i class="fas fa-check-circle"></i> Verified</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="study-card__body">
                                        <h3 class="study-card__title">{{ resource.title }}</h3>
                                        
                                        {% if resource.description %}
                                        <p class="study-card__description">{{ resource.description|truncatewords:20 }}</p>
                                        {% endif %}

                                        <p class="study-card__author">By: {{ resource.uploader.get_full_name|default:resource.uploader.username }}</p>

                                        <div class="study-card__metrics">
                                            <span><i class="fas fa-heart"></i> {{ resource.likes.count }}</span>
                                            <span class="metric-dot">•</span>
                                            <span><i class="fas fa-download"></i> {{ resource.download_count }}</span>
                                            {% if resource.get_average_rating %}
                                            <span class="metric-dot">•</span>
                                            <span><i class="fas fa-star"></i> {{ resource.get_average_rating|floatformat:1 }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                            </div>
                            {% endfor %}

                            <!-- Flashcards -->
                            {% for deck in user_decks %}
                            <div class="col-md-6 col-lg-4" data-upload-type="flashcards">
                                <a href="{% url 'flashcards:deck_detail' deck.pk %}" class="study-card study-card--clickable">
                                    <div class="study-card__header">
                                        <div class="study-card__header-left">
                                            <span class="study-card__type">Flashcard</span>
                                            {% if deck.verification_status == 'verified' %}
                                            <span class="study-card__tag study-card__tag--verified"><i class="fas fa-check-circle"></i> Verified</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="study-card__body">
                                        <h3 class="study-card__title">{{ deck.title }}</h3>
                                        
                                        {% if deck.description %}
                                        <p class="study-card__description">{{ deck.description|truncatewords:20 }}</p>
                                        {% endif %}

                                        <p class="study-card__author">By: {{ deck.owner.get_full_name|default:deck.owner.username }}</p>

                                        <div class="study-card__metrics">
                                            <span><i class="fas fa-heart"></i> {{ deck.likes.count }}</span>
                                            <span class="metric-dot">•</span>
                                            <span><i class="fas fa-star"></i> {{ deck.get_average_rating }}</span>
                                            <span class="metric-dot">•</span>
                                            <span><i class="fas fa-layer-group"></i> {{ deck.cards_count }} card{{ deck.cards_count|pluralize }}</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            {% endfor %}

                            <!-- Quizzes -->
                            {% for quiz in user_quizzes %}
                            <div class="col-md-6 col-lg-4" data-upload-type="quizzes">
                                <a href="{% url 'quizzes:quiz_detail' quiz.pk %}" class="study-card study-card--clickable">
                                    <div class="study-card__header">
                                        <div class="study-card__header-left">
                                            <span class="study-card__type">Quiz</span>
                                            {% if quiz.verification_status == 'verified' %}
                                            <span class="study-card__tag study-card__tag--verified"><i class="fas fa-check-circle"></i> Verified</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="study-card__body">
                                        <h3 class="study-card__title">{{ quiz.title }}</h3>
                                        
                                        {% if quiz.description %}
                                        <p class="study-card__description">{{ quiz.description|truncatewords:20 }}</p>
                                        {% endif %}

                                        <p class="study-card__author">By: {{ quiz.creator.get_full_name|default:quiz.creator.username }}</p>

                                        <div class="study-card__metrics">
                                            <span><i class="fas fa-heart"></i> {{ quiz.likes.count }}</span>
                                            <span class="metric-dot">•</span>
                                            <span><i class="fas fa-question-circle"></i> {{ quiz.total_questions }} Q</span>
                                            <span class="metric-dot">•</span>
                                            <span><i class="fas fa-chart-line"></i> {{ quiz.attempts_count }} attempt{{ quiz.attempts_count|pluralize }}</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">This user hasn't uploaded any content yet.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Tab switching functionality (simplified - no edit mode needed)
function switchTab(tabName) {
    // Remove active class from all tabs and panels
    const allTabBtns = document.querySelectorAll('.profile-tab-btn');
    const allTabPanels = document.querySelectorAll('.profile-tab-panel');
    
    allTabBtns.forEach(btn => btn.classList.remove('active'));
    allTabPanels.forEach(panel => panel.classList.remove('active'));
    
    // Add active class to selected tab and panel
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    const activePanel = document.getElementById(`${tabName}-tab`);
    
    if (activeBtn && activePanel) {
        activeBtn.classList.add('active');
        activePanel.classList.add('active');
    }
}

// Filter uploads functionality
function filterUploads(filterType) {
    const uploadsContainer = document.getElementById('uploads-container');
    const allItems = uploadsContainer.querySelectorAll('[data-upload-type]');
    
    if (filterType === 'all') {
        // Show all items
        allItems.forEach(item => {
            item.style.display = '';
        });
    } else {
        // Show only matching type
        allItems.forEach(item => {
            if (item.dataset.uploadType === filterType) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // Check if any items are visible after filtering
    const visibleItems = Array.from(allItems).filter(item => item.style.display !== 'none');
    
    // Show/hide empty state
    let emptyState = uploadsContainer.querySelector('.empty-filter-state');
    
    if (visibleItems.length === 0) {
        if (!emptyState) {
            emptyState = document.createElement('div');
            emptyState.className = 'empty-filter-state text-center py-5';
            emptyState.innerHTML = `
                <i class="fas fa-filter fa-3x text-muted mb-3"></i>
                <p class="text-muted">No ${filterType === 'all' ? 'uploads' : filterType} found.</p>
            `;
            uploadsContainer.querySelector('.row').style.display = 'none';
            uploadsContainer.appendChild(emptyState);
        }
    } else {
        if (emptyState) {
            emptyState.remove();
            uploadsContainer.querySelector('.row').style.display = '';
        }
    }
}
</script>
{% endblock %}
