{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Profile - PaperTrail{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile_style.css' %}?v=5.0">
{% endblock %}

{% block header %}
{% url 'accounts:dashboard' as dashboard_url %}
{% include 'components/page_header.html' with page_title='My Profile' back_url=dashboard_url show_moderate_btn=False %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Profile Content -->
        <div class="col-lg-8 offset-lg-2">
            <!-- Profile Header Card -->
            <div class="profile-card profile-header-card mb-4">
                <div class="profile-header-content">
                    <!-- Profile Photo -->
                    <div class="profile-photo-wrapper">
                        <img id="profileImage" 
                             src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}https://ui-avatars.com/api/?name={{ user.first_name }}+{{ user.last_name }}&size=150&background=667eea&color=fff{% endif %}" 
                             alt="Profile Photo" 
                             class="profile-photo-xl">
                        <div class="photo-edit-overlay" onclick="document.getElementById('photoUpload').click()">
                            <i class="fas fa-camera"></i>
                            <span class="edit-text">Change Photo</span>
                        </div>
                        <form id="photoUploadForm" method="post" enctype="multipart/form-data" action="{% url 'accounts:update_profile_picture' %}" style="display: none;">
                            {% csrf_token %}
                            <input type="file" id="photoUpload" name="profile_picture" accept="image/*" onchange="handlePhotoUpload(this)">
                        </form>
                    </div>
                    
                    <!-- User Info -->
                    <div class="profile-identity">
                        <h2 class="profile-name">{{ user.get_full_name|default:user.username }}</h2>
                        <span class="profile-role-badge">
                            {% if user.is_staff or user.is_superuser %}
                            <i class="fas fa-crown"></i> Admin
                            {% elif user.is_professor %}
                            <i class="fas fa-chalkboard-teacher"></i> Professor
                            {% else %}
                            <i class="fas fa-user-graduate"></i> Student
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Profile Information Card -->
            <div class="profile-card">
                <div class="card-header-row">
                    <h3 class="card-title">
                        <i class="fas fa-user"></i>
                        Profile Information
                    </h3>
                </div>

                <!-- Tab Navigation -->
                <div class="profile-tabs-nav">
                    <button class="profile-tab-btn active" data-tab="personal" onclick="switchTab('personal')">
                        <i class="fas fa-user"></i>
                        <span>Personal Info</span>
                    </button>
                    <button class="profile-tab-btn" data-tab="academic" onclick="switchTab('academic')">
                        <i class="fas fa-university"></i>
                        <span>Academic Info</span>
                    </button>
                    <button class="profile-tab-btn" data-tab="about" onclick="switchTab('about')">
                        <i class="fas fa-edit"></i>
                        <span>About Me</span>
                    </button>
                </div>

                <!-- Tab Panels -->
                <div class="profile-tabs-content">
                    <!-- Personal Info Tab -->
                    <div class="profile-tab-panel active" id="personal-tab">
                        <div class="tab-panel-header">
                            <h3 class="tab-panel-title">Personal Information</h3>
                            <button class="btn-edit-mode" onclick="toggleEditMode('personalInfo')">
                                <i class="fas fa-pencil-alt"></i>
                                Edit
                            </button>
                        </div>

                        <!-- Display Mode -->
                        <div id="personalInfo-display" class="info-display-grid">
                            <div class="info-field">
                                <label class="info-field-label">First Name</label>
                                <div class="info-field-value {% if not user.first_name %}empty{% endif %}">
                                    {{ user.first_name|default:"Not provided" }}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Last Name</label>
                                <div class="info-field-value {% if not user.last_name %}empty{% endif %}">
                                    {{ user.last_name|default:"Not provided" }}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Personal Email</label>
                                <div class="info-field-value {% if not user.personal_email %}empty{% endif %}">
                                    {{ user.personal_email|default:"Not provided" }}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Phone Number</label>
                                <div class="info-field-value {% if not user.phone %}empty{% endif %}">
                                    {{ user.phone|default:"Not provided" }}
                                </div>
                            </div>
                        </div>

                        <!-- Edit Mode -->
                        <div id="personalInfo-edit" class="edit-form-container">
                            <form method="post" action="{% url 'accounts:profile' %}" id="personalInfoForm">
                                {% csrf_token %}
                                <!-- Hidden fields to preserve data from other tabs -->
                                <input type="hidden" name="univ_email" value="{{ user.univ_email }}">
                                <input type="hidden" name="stud_id" value="{{ user.stud_id }}">
                                <input type="hidden" name="department" value="{{ user.department|default:'' }}">
                                <input type="hidden" name="year_level" value="{{ user.year_level|default:'' }}">
                                <input type="hidden" name="bio" value="{{ user.bio|default:'' }}">
                                <input type="hidden" name="profile_visibility" value="{{ user.profile_visibility }}">
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" id="firstName" name="first_name" value="{{ user.first_name }}" placeholder="Enter first name" required>
                                        {% if form.first_name.errors %}
                                            <div class="invalid-feedback">{{ form.first_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" id="lastName" name="last_name" value="{{ user.last_name }}" placeholder="Enter last name" required>
                                        {% if form.last_name.errors %}
                                            <div class="invalid-feedback">{{ form.last_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="personalEmail" class="form-label">Personal Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control {% if form.personal_email.errors %}is-invalid{% endif %}" id="personalEmail" name="personal_email" value="{{ user.personal_email }}" placeholder="your.email@example.com" required>
                                        {% if form.personal_email.errors %}
                                            <div class="invalid-feedback">{{ form.personal_email.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="phone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control {% if form.phone.errors %}is-invalid{% endif %}" id="phone" name="phone" value="{{ user.phone|default:'' }}" placeholder="+63 912 345 6789" pattern="[0-9+\-\s]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9+\-\s]/g, '')">
                                        {% if form.phone.errors %}
                                            <div class="invalid-feedback">{{ form.phone.errors.0 }}</div>
                                        {% else %}
                                            <div class="invalid-feedback">Please enter a valid phone number (numbers, +, -, and spaces only)</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="cancelEdit('personalInfo')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Academic Info Tab -->
                    <div class="profile-tab-panel" id="academic-tab">
                        <div class="tab-panel-header">
                            <h3 class="tab-panel-title">Academic Information</h3>
                            <button class="btn-edit-mode" onclick="toggleEditMode('academicInfo')">
                                <i class="fas fa-pencil-alt"></i>
                                Edit
                            </button>
                        </div>

                        <!-- Display Mode -->
                        <div id="academicInfo-display" class="info-display-grid">
                            <div class="info-field">
                                <label class="info-field-label">University Email</label>
                                <div class="info-field-value">
                                    {{ user.univ_email }}
                                    <small class="text-muted d-block mt-1">Set during registration</small>
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Student ID</label>
                                <div class="info-field-value">
                                    {{ user.stud_id }}
                                    <small class="text-muted d-block mt-1">Set during registration</small>
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Department</label>
                                <div class="info-field-value {% if not user.department %}empty{% endif %}">
                                    {{ user.department|default:"Not provided" }}
                                </div>
                            </div>
                            <div class="info-field">
                                <label class="info-field-label">Year Level</label>
                                <div class="info-field-value {% if not user.year_level %}empty{% endif %}">
                                    {% if user.year_level %}{{ user.year_level }}{% if user.year_level == '1' %}st{% elif user.year_level == '2' %}nd{% elif user.year_level == '3' %}rd{% else %}th{% endif %} Year{% else %}Not provided{% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Edit Mode -->
                        <div id="academicInfo-edit" class="edit-form-container">
                            <form method="post" action="{% url 'accounts:profile' %}" id="academicInfoForm">
                                {% csrf_token %}
                                <!-- Hidden fields to preserve data from other tabs -->
                                <input type="hidden" name="first_name" value="{{ user.first_name }}">
                                <input type="hidden" name="last_name" value="{{ user.last_name }}">
                                <input type="hidden" name="personal_email" value="{{ user.personal_email }}">
                                <input type="hidden" name="phone" value="{{ user.phone|default:'' }}">
                                <input type="hidden" name="bio" value="{{ user.bio|default:'' }}">
                                <input type="hidden" name="profile_visibility" value="{{ user.profile_visibility }}">
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="univEmail" class="form-label">University Email</label>
                                        <input type="email" class="form-control" id="univEmail" name="univ_email" value="{{ user.univ_email }}" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                                        <small class="form-text text-muted">This field cannot be changed</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="studentId" class="form-label">Student ID</label>
                                        <input type="text" class="form-control" id="studentId" name="stud_id" value="{{ user.stud_id }}" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                                        <small class="form-text text-muted">This field cannot be changed</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="department" class="form-label">Department</label>
                                        <input type="text" class="form-control {% if form.department.errors %}is-invalid{% endif %}" id="department" name="department" value="{{ user.department|default:'' }}" placeholder="e.g., Computer Science">
                                        {% if form.department.errors %}
                                            <div class="invalid-feedback">{{ form.department.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="yearLevel" class="form-label">Year Level</label>
                                        <select class="form-control {% if form.year_level.errors %}is-invalid{% endif %}" id="yearLevel" name="year_level">
                                            <option value="">Select year</option>
                                            <option value="1" {% if user.year_level == '1' %}selected{% endif %}>1st Year</option>
                                            <option value="2" {% if user.year_level == '2' %}selected{% endif %}>2nd Year</option>
                                            <option value="3" {% if user.year_level == '3' %}selected{% endif %}>3rd Year</option>
                                            <option value="4" {% if user.year_level == '4' %}selected{% endif %}>4th Year</option>
                                        </select>
                                        {% if form.year_level.errors %}
                                            <div class="invalid-feedback">{{ form.year_level.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="cancelEdit('academicInfo')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- About Me Tab -->
                    <div class="profile-tab-panel" id="about-tab">
                        <div class="tab-panel-header">
                            <h3 class="tab-panel-title">About Me</h3>
                            <button class="btn-edit-mode" onclick="toggleEditMode('bioInfo')">
                                <i class="fas fa-pencil-alt"></i>
                                Edit
                            </button>
                        </div>

                        <!-- Display Mode -->
                        <div id="bioInfo-display">
                            <div class="info-field">
                                <label class="info-field-label">Bio</label>
                                <div class="info-field-value bio-text {% if not user.bio %}empty{% endif %}">
                                    {% if user.bio %}
                                        {{ user.bio|linebreaks }}
                                    {% else %}
                                        Tell others about yourself...
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Edit Mode -->
                        <div id="bioInfo-edit" class="edit-form-container">
                            <form method="post" action="{% url 'accounts:profile' %}" id="bioInfoForm">
                                {% csrf_token %}
                                <!-- Hidden fields to preserve data from other tabs -->
                                <input type="hidden" name="first_name" value="{{ user.first_name }}">
                                <input type="hidden" name="last_name" value="{{ user.last_name }}">
                                <input type="hidden" name="personal_email" value="{{ user.personal_email }}">
                                <input type="hidden" name="phone" value="{{ user.phone|default:'' }}">
                                <input type="hidden" name="univ_email" value="{{ user.univ_email }}">
                                <input type="hidden" name="stud_id" value="{{ user.stud_id }}">
                                <input type="hidden" name="department" value="{{ user.department|default:'' }}">
                                <input type="hidden" name="year_level" value="{{ user.year_level|default:'' }}">
                                <input type="hidden" name="profile_visibility" value="{{ user.profile_visibility }}">
                                
                                <div class="form-group full-width">
                                    <label for="bio" class="form-label">Bio</label>
                                    <textarea class="form-control {% if form.bio.errors %}is-invalid{% endif %}" id="bio" name="bio" rows="6" maxlength="500" placeholder="Tell others about yourself...">{{ user.bio|default:'' }}</textarea>
                                    {% if form.bio.errors %}
                                        <div class="invalid-feedback">{{ form.bio.errors.0 }}</div>
                                    {% endif %}
                                    <small class="text-muted"><span id="bioCharCount">{{ user.bio|length|default:0 }}</span>/500 characters</small>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="cancelEdit('bioInfo')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/profile_clean.js' %}?v=1.0"></script>
{% endblock %}
