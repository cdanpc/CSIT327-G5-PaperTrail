{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - PaperTrail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/globals.css' %}?v=1.1">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=4.5">
    <link rel="stylesheet" href="{% static 'css/layout.css' %}?v=1.3">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}?v=3.9">
    <link rel="stylesheet" href="{% static 'css/coming-soon-notification.css' %}?v=1.0">
    <link rel="stylesheet" href="{% static 'css/settings.css' %}?v=3.0">
    <link rel="stylesheet" href="{% static 'css/toast.css' %}?v=1.0">
</head>
<body>
    <!-- Toast Messages Component -->
    {% include 'components/toast_messages.html' %}

    <!-- Include Sidebar -->
    {% include 'includes/sidebar.html' %}
    
    <!-- Main Content Wrapper -->
    <div class="main-content-wrapper">
        <!-- Dashboard Main -->
        <div class="dashboard-main">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="settings-header">
                    <h1 class="settings-page-title">
                        Account Settings
                    </h1>
                    <p class="settings-subtitle">Manage your account preferences and security</p>
                    
                    <!-- Role Badge -->
                    <div class="role-badge-container">
                        {% if user.is_staff or user.is_superuser %}
                            <span class="badge badge-admin">
                                <i class="fas fa-crown"></i> Admin
                            </span>
                        {% elif user.is_professor %}
                            <span class="badge badge-professor">
                                <i class="fas fa-chalkboard-teacher"></i> Professor
                            </span>
                        {% else %}
                            <span class="badge badge-student">
                                <i class="fas fa-user-graduate"></i> Student
                            </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Settings Content -->
                <div class="settings-content">
                <!-- Account Security Card -->
                <div class="settings-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-shield-alt"></i>
                            Account Security
                        </h3>
                        <p class="card-subtitle">Manage your password and email settings</p>
                    </div>
                    
                    <div class="card-body">
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4 class="setting-title">Password</h4>
                                <p class="setting-description">Change your password to keep your account secure</p>
                            </div>
                            <div class="setting-action">
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                    <i class="fas fa-key me-2"></i>
                                    Change Password
                                </button>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4 class="setting-title">University Email</h4>
                                <p class="setting-description">Update your university email (requires verification)</p>
                                <small class="text-muted">Current: {{ user.univ_email }}</small>
                            </div>
                            <div class="setting-action">
                                {% if pending_email_change %}
                                    <button class="btn btn-outline-primary" disabled title="You have an ongoing request to change your university email">
                                        <i class="fas fa-university me-2"></i>
                                        Change Email
                                    </button>
                                {% else %}
                                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changeUnivEmailModal">
                                        <i class="fas fa-university me-2"></i>
                                        Change Email
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                                    
                                    <!--
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title">Two-Factor Authentication</h4>
                                            <p class="setting-description">Add an extra layer of security to your account</p>
                                            <span class="badge bg-warning text-dark">Coming Soon</span>
                                        </div>
                                        <button class="btn btn-outline-secondary" disabled>
                                            <i class="fas fa-mobile-alt"></i>
                                            Enable 2FA
                                        </button>
                                    </div>
                                    -->
                                </div>
                            </div>

                            <!-- Preferences Card -->
                            <div class="profile-card">
                                <div class="card-header-row">
                                    <h3 class="card-title">
                                        <i class="fas fa-sliders-h"></i>
                                        Preferences
                                    </h3>
                                </div>
                                
                                <form method="post" id="preferencesForm">
                                    {% csrf_token %}
                                    <input type="hidden" name="save_preferences" value="1">
                                    
                                    <div class="settings-section">
                                        <div class="setting-item">
                                            <div class="setting-info">
                                                <h4 class="setting-title">Default Dashboard View</h4>
                                                <p class="setting-description">Choose which page to see when you log in</p>
                                            </div>
                                            <select class="form-select settings-select" name="default_dashboard" id="defaultDashboard">
                                                {% for value, label in dashboard_choices %}
                                                    <option value="{{ value }}" {% if user.default_dashboard == value %}selected{% endif %}>
                                                        {{ label }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        

                                        
                                        <!--
                                        <div class="setting-item">
                                            <div class="setting-info">
                                                <h4 class="setting-title">Theme Mode</h4>
                                                <p class="setting-description">Customize the appearance of PaperTrail</p>
                                                <span class="badge bg-info text-dark">Coming in Phase 8</span>
                                            </div>
                                            <select class="form-select settings-select" disabled>
                                                <option value="light" selected>Light</option>
                                                <option value="dark">Dark</option>
                                                <option value="auto">System Default</option>
                                            </select>
                                        </div>
                                        -->
                                        
                                        <div class="setting-item">
                                            <div class="setting-info"></div>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Notifications Card -->
                            <div class="profile-card">
                                <div class="card-header-row">
                                    <h3 class="card-title">
                                        <i class="fas fa-bell"></i>
                                        Notifications
                                    </h3>
                                </div>
                                
                                <div class="settings-section">
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title">Email Notifications</h4>
                                            <p class="setting-description">Receive updates about your uploads and activity</p>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input notification-toggle" type="checkbox" 
                                                   id="emailNotifications" 
                                                   {% if user.email_notifications %}checked{% endif %}>
                                            <label class="form-check-label" for="emailNotifications"></label>
                                        </div>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title">Resource Downloads</h4>
                                            <p class="setting-description">Get notified when your uploaded resources are downloaded</p>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input notification-toggle" type="checkbox" 
                                                   id="resourceDownloads" 
                                                   {% if user.notify_resource_downloads %}checked{% endif %}>
                                            <label class="form-check-label" for="resourceDownloads"></label>
                                        </div>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title">Quiz Submissions</h4>
                                            <p class="setting-description">Receive notifications about quiz submissions and results</p>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input notification-toggle" type="checkbox" 
                                                   id="quizSubmissions" 
                                                   {% if user.notify_quiz_submissions %}checked{% endif %}>
                                            <label class="form-check-label" for="quizSubmissions"></label>
                                        </div>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title">System Updates</h4>
                                            <p class="setting-description">Receive announcements and important system updates</p>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input notification-toggle" type="checkbox" 
                                                   id="systemUpdates" 
                                                   {% if user.notify_system_updates %}checked{% endif %}>
                                            <label class="form-check-label" for="systemUpdates"></label>
                                        </div>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title">Weekly Summary</h4>
                                            <p class="setting-description">Receive a weekly summary of your PaperTrail activity</p>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input notification-toggle" type="checkbox" 
                                                   id="weeklySummary" 
                                                   {% if user.notify_weekly_summary %}checked{% endif %}>
                                            <label class="form-check-label" for="weeklySummary"></label>
                                        </div>
                                    </div>
                                    

                                </div>
                            </div>

                            <!-- Privacy & Security Card -->
                            <div class="profile-card">
                                <div class="card-header-row">
                                    <h3 class="card-title">
                                        <i class="fas fa-user-shield"></i>
                                        Privacy & Security
                                    </h3>
                                </div>
                                
                                <div class="settings-section">
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title">Profile Visibility</h4>
                                            <p class="setting-description">Control who can see your profile information</p>
                                        </div>
                                        <select class="form-select settings-select" id="profileVisibility">
                                            {% for value, label in visibility_choices %}
                                                <option value="{{ value }}" {% if user.profile_visibility == value %}selected{% endif %}>
                                                    {{ label }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title">Active Sessions</h4>
                                            <p class="setting-description">View and manage devices where you're logged in</p>
                                        </div>
                                        <button class="btn btn-outline-primary" id="viewSessionsBtn">
                                            <i class="fas fa-laptop"></i>
                                            View Devices
                                        </button>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title">Logout All Sessions</h4>
                                            <p class="setting-description">Sign out from all devices except this one</p>
                                        </div>
                                        <button class="btn btn-outline-warning" id="logoutAllBtn">
                                            <i class="fas fa-sign-out-alt"></i>
                                            Logout All Devices
                                        </button>
                                    </div>
                                    

                                </div>
                            </div>

                            <!-- Danger Zone Card -->
                            <div class="profile-card border-danger">
                                <div class="card-header-row">
                                    <h3 class="card-title text-danger">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Danger Zone
                                    </h3>
                                </div>
                                
                                <div class="settings-section">
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <h4 class="setting-title text-danger">Delete Account</h4>
                                            <p class="setting-description">Permanently delete your account and all associated data. This action cannot be undone.</p>
                                        </div>
                                        <button class="btn btn-outline-danger" id="deleteAccountBtn">
                                            <i class="fas fa-trash-alt"></i>
                                            Delete Account
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" id="passwordChangeForm" action="{% url 'accounts:password_change' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Password Requirements:</strong>
                            <ul class="mb-0 mt-2">
                                <li>At least 8 characters long</li>
                                <li>Must contain at least one letter</li>
                                <li>Must contain at least one number</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <label for="old_password" class="form-label">
                                <i class="fas fa-lock me-2"></i>Current Password
                            </label>
                            <input type="password" class="form-control" id="old_password" name="old_password" required>
                        </div>

                        <div class="mb-3">
                            <label for="new_password1" class="form-label">
                                <i class="fas fa-key me-2"></i>New Password
                            </label>
                            <input type="password" class="form-control" id="new_password1" name="new_password1" required>
                            <div class="password-requirements-check mt-2" style="display: none;" id="passwordRequirements">
                                <small class="requirement" id="req-length">
                                    <i class="fas fa-circle text-muted"></i>
                                    <span>At least 8 characters</span>
                                </small><br>
                                <small class="requirement" id="req-letter">
                                    <i class="fas fa-circle text-muted"></i>
                                    <span>Contains a letter</span>
                                </small><br>
                                <small class="requirement" id="req-number">
                                    <i class="fas fa-circle text-muted"></i>
                                    <span>Contains a number</span>
                                </small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="new_password2" class="form-label">
                                <i class="fas fa-check-double me-2"></i>Confirm New Password
                            </label>
                            <input type="password" class="form-control" id="new_password2" name="new_password2" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-2"></i>Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change University Email Modal -->
    <div class="modal fade" id="changeUnivEmailModal" tabindex="-1" aria-labelledby="changeUnivEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeUnivEmailModalLabel">
                        <i class="fas fa-university me-2"></i>Change University Email
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" id="changeUnivEmailForm" action="{% url 'accounts:change_university_email' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Current Email:</strong> {{ user.univ_email }}
                        </div>

                        <div class="mb-3">
                            <label for="new_univ_email" class="form-label">
                                <i class="fas fa-university me-2"></i>New University Email
                            </label>
                            <input type="email" class="form-control" id="new_univ_email" name="new_univ_email" required>
                        </div>

                        <div class="mb-3">
                            <label for="reason" class="form-label">
                                <i class="fas fa-comment-alt me-2"></i>Reason for Change
                            </label>
                            <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="password_univ" class="form-label">
                                <i class="fas fa-lock me-2"></i>Current Password
                            </label>
                            <input type="password" class="form-control" id="password_univ" name="password" required>
                            <small class="text-muted">Please enter your password to confirm these changes.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>Submit for Verification
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/sidebar.js' %}?v=3.1"></script>
    <script src="{% static 'js/coming-soon-notification.js' %}?v=1.0"></script>
    <script src="{% static 'js/settings.js' %}?v=2.1"></script>
</body>
</html>
