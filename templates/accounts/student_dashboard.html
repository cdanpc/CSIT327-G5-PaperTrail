{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block header %}
{% include 'components/page_header.html' with page_title="Dashboard" page_subtitle=dashboard_date_str search_placeholder="Search..." %}
{% endblock %}

{% block extra_css %}
<style>
/* Dashboard entrance animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in-up {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
}

.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }
.delay-3 { animation-delay: 0.3s; }
.delay-4 { animation-delay: 0.4s; }

/* Custom Grid Layout Override */
.dashboard-grid-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: 1fr;
    gap: 1rem;
    margin-bottom: 2rem;
    grid-template-areas:
        "quick-actions continue-studying recommended";
}

/* Uniform Card Height */
.dashboard-grid-container .card {
    height: 500px;
    max-height: 500px;
    display: flex;
    flex-direction: column;
}

.dashboard-grid-container .card-body {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

/* Quick Actions Layout Adjustment */
.quick-actions-body {
    height: 100%;
}

.qa-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 columns */
    grid-template-rows: 1fr 1fr; /* 2 rows */
    gap: 1rem;
    height: 100%;
    padding: 0;
}

.qa-tile {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
}

/* Responsive adjustments */
@media (max-width: 991px) {
    .dashboard-grid-container {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto;
        grid-template-areas:
            "quick-actions quick-actions"
            "continue-studying recommended";
    }
    .dashboard-grid-container .card {
        height: 400px; /* Slightly shorter on tablets */
    }
}

@media (max-width: 768px) {
    .dashboard-grid-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        grid-template-areas:
            "quick-actions"
            "continue-studying"
            "recommended";
    }
    .dashboard-grid-container .card {
        height: auto;
        min-height: 300px;
    }
}
</style>
{% endblock %}

<!-- In-progress Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="inProgressToast" class="toast align-items-center text-bg-secondary border-0" role="status" aria-live="polite" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">This feature is in progress.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

{% block content %}
<!-- Dynamic Greeting & Streak Banner -->
<div class="row mb-3">
    <div class="col-12">
        <div class="greeting-banner fade-in-up">
            <div class="greeting-content">
                <h2 class="greeting-text" id="dynamicGreeting">Good day, {{ user.first_name }}!</h2>
                <p class="greeting-subtitle">Ready to continue your learning journey?</p>
            </div>
            <div class="streak-display">
                <div class="streak-icon-small">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="streak-info">
                    <div class="streak-number-small">{{ study_streak|default:0 }}</div>
                    <div class="streak-label-small">Day Streak</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Row (4 cards) -->
<div class="row g-3 mb-3">
    <div class="col-12 col-md-6 col-lg-6 col-xxl-3 fade-in-up delay-1">
        <div class="stat-card stat-card-purple h-100">
            <div class="stat-icon"><i class="fas fa-folder"></i></div>
            <div class="stat-content">
                <div class="stat-label">Total Resources</div>
                <div class="stat-value" data-target="{{ total_resources }}">0</div>
                <div class="stat-sublabel">From your library</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-6 col-xxl-3 fade-in-up delay-2">
        <div class="stat-card stat-card-green h-100">
            <div class="stat-icon"><i class="fas fa-question-circle"></i></div>
            <div class="stat-content">
                <div class="stat-label">Total Quizzes</div>
                <div class="stat-value" data-target="{{ total_quizzes_posted|default:0 }}">0</div>
                <div class="stat-sublabel">Available quizzes</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-6 col-xxl-3 fade-in-up delay-3">
        <div class="stat-card stat-card-blue h-100">
            <div class="stat-icon"><i class="fas fa-bookmark"></i></div>
            <div class="stat-content">
                <div class="stat-label">Bookmarks</div>
                <div class="stat-value" data-target="{{ total_bookmarks }}">0</div>
                <div class="stat-sublabel">Saved for later</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-6 col-xxl-3 fade-in-up delay-4">
        <div class="stat-card stat-card-teal h-100">
            <div class="stat-icon"><i class="fas fa-clone"></i></div>
            <div class="stat-content">
                <div class="stat-label">Flashcard Decks</div>
                <div class="stat-value" data-target="{{ total_flashcard_decks|default:0 }}">0</div>
                <div class="stat-sublabel">Your study sets</div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Grid Layout -->
<div class="dashboard-grid-container">
    <!-- Quick Actions -->
    <div class="grid-item grid-quick-actions">
        <div class="card dashboard-card quick-actions-card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body quick-actions-body">
                <div class="qa-grid">
                    <a class="qa-tile qa-green" href="{% url 'resources:resource_upload' %}" aria-label="Upload Resource">
                        <div class="qa-icon"><i class="fas fa-upload"></i></div>
                        <div class="qa-title">Upload</div>
                    </a>
                    <a class="qa-tile qa-amber" href="{% url 'resources:resource_list' %}" aria-label="Browse Library">
                        <div class="qa-icon"><i class="fas fa-book"></i></div>
                        <div class="qa-title">Library</div>
                    </a>
                    <a class="qa-tile qa-blue" href="{% url 'quizzes:quiz_create' %}" aria-label="Create Quiz">
                        <div class="qa-icon"><i class="fas fa-plus-circle"></i></div>
                        <div class="qa-title">Create Quiz</div>
                    </a>
                    <a class="qa-tile qa-purple" href="{% url 'flashcards:deck_list' %}" aria-label="Flashcards">
                        <div class="qa-icon"><i class="fas fa-clone"></i></div>
                        <div class="qa-title">Flashcards</div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Continue Studying -->
    <div class="grid-item grid-continue-studying">
        <div class="card dashboard-card continue-studying-card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">Continue Studying</h5>
            </div>
            <div class="card-body">
                {% if in_progress_quiz_attempts or recent_decks %}
                    <ul class="list-unstyled mb-0 continue-list">
                        {% for attempt in in_progress_quiz_attempts|slice:":3" %}
                            <li class="continue-item">
                                <div class="continue-left">
                                    <div class="continue-icon quiz-icon">
                                        <i class="fas fa-question-circle"></i>
                                    </div>
                                    <div class="continue-content">
                                        <a href="{% url 'quizzes:quiz_attempt' attempt.quiz.id %}" class="continue-title">{{ attempt.quiz.title|truncatechars:35 }}</a>
                                        <div class="continue-meta">{{ attempt.questions_answered }}/{{ attempt.total_questions }} questions</div>
                                    </div>
                                </div>
                                <div class="continue-center">
                                    <div class="continue-time">{{ attempt.started_at|date:"M d" }}{% if attempt.started_at.year != today.year %}, {{ attempt.started_at|date:"Y" }}{% endif %}</div>
                                </div>
                                <div class="continue-right">
                                    <span class="continue-badge badge-progress">In Progress</span>
                                </div>
                            </li>
                        {% endfor %}
                        {% for deck in recent_decks|slice:":2" %}
                            <li class="continue-item">
                                <div class="continue-left">
                                    <div class="continue-icon deck-icon">
                                        <i class="fas fa-clone"></i>
                                    </div>
                                    <div class="continue-content">
                                        <a href="{% url 'flashcards:deck_detail' deck.id %}" class="continue-title">{{ deck.title|truncatechars:35 }}</a>
                                        <div class="continue-meta">{{ deck.cards.count }} cards</div>
                                    </div>
                                </div>
                                <div class="continue-center">
                                    <div class="continue-time">{% if deck.last_studied_at %}{{ deck.last_studied_at|date:"M d" }}{% if deck.last_studied_at.year != today.year %}, {{ deck.last_studied_at|date:"Y" }}{% endif %}{% else %}Never{% endif %}</div>
                                </div>
                                <div class="continue-right">
                                    <span class="continue-badge badge-review">Review</span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-book-open fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No items in progress</p>
                        <small>Start a quiz or create flashcards!</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recommended for You -->
    <div class="grid-item grid-recommended">
        <div class="card dashboard-card recommended-card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">Recommended for You</h5>
            </div>
            <div class="card-body">
                {% if top_rated_resources %}
                    <ul class="list-unstyled mb-0 recommended-list">
                        {% for resource in top_rated_resources|slice:":4" %}
                            <li class="recommended-list-item">
                                <div class="recommended-left">
                                    <div class="recommended-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="recommended-content">
                                        <a href="{% url 'resources:resource_detail' resource.id %}" class="recommended-title">{{ resource.title|truncatechars:35 }}</a>
                                        <div class="recommended-meta">{{ resource.subject.name|truncatechars:20 }}</div>
                                    </div>
                                </div>
                                <div class="recommended-center">
                                    <div class="recommended-time">{{ resource.created_at|date:"M d" }}{% if resource.created_at.year != today.year %}, {{ resource.created_at|date:"Y" }}{% endif %}</div>
                                </div>
                                <div class="recommended-right">
                                    <div class="recommended-rating"><i class="fas fa-star"></i> {{ resource.avg_rating|floatformat:1 }}</div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-lightbulb fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No recommendations yet</p>
                        <small>Check back soon!</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- End Dashboard Grid -->
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const greetingEl = document.getElementById('dynamicGreeting');
    if (!greetingEl) return;
    
    const firstName = greetingEl.textContent.split(', ')[1].replace('!', '');
    
    // Check if user just logged in or is new (from session/localStorage)
    const justLoggedIn = sessionStorage.getItem('justLoggedIn');
    const isNewUser = sessionStorage.getItem('isNewUser');
    
    function getTimeBasedGreeting() {
        const hour = new Date().getHours();
        
        if (hour >= 0 && hour < 12) {
            return 'Good morning';
        } else if (hour === 12) {
            return 'Good noon';
        } else if (hour >= 13 && hour < 18) {
            return 'Good afternoon';
        } else if (hour >= 18 && hour < 24) {
            return 'Good evening';
        }
        return 'Good day';
    }
    
    function updateGreeting() {
        let greeting;
        
        if (isNewUser === 'true') {
            greeting = 'Welcome';
            sessionStorage.removeItem('isNewUser');
            sessionStorage.setItem('justLoggedIn', 'true');
        } else if (justLoggedIn === 'true') {
            greeting = 'Welcome back';
        } else {
            greeting = getTimeBasedGreeting();
        }
        
        greetingEl.textContent = `${greeting}, ${firstName}!`;
    }
    
    // Initial greeting
    updateGreeting();
    
    // If just logged in, change to time-based greeting after 10 seconds
    if (justLoggedIn === 'true') {
        setTimeout(() => {
            sessionStorage.removeItem('justLoggedIn');
            greetingEl.textContent = `${getTimeBasedGreeting()}, ${firstName}!`;
        }, 10000); // 10 seconds
    }
    
    // Count-up animation for stat values
    function animateValue(element, start, end, duration) {
        if (start === end) {
            element.textContent = end;
            return;
        }
        const range = end - start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(Math.floor(duration / range));
        let current = start;
        
        const timer = setInterval(function() {
            current += increment;
            element.textContent = current;
            if (current === end) {
                clearInterval(timer);
            }
        }, stepTime);
    }
    
    // Trigger count-up animation on all stat cards
    const statValues = document.querySelectorAll('.stat-value');
    statValues.forEach((stat, index) => {
        const target = parseInt(stat.getAttribute('data-target')) || 0;
        setTimeout(() => {
            animateValue(stat, 0, target, 1200);
        }, 300 + (index * 100)); // Staggered start
    });
    
    // Make entire Continue Studying items clickable with dashboard return flag
    document.querySelectorAll('.continue-item').forEach(item => {
        const link = item.querySelector('.continue-title');
        if (link) {
            item.style.cursor = 'pointer';
            item.addEventListener('click', function(e) {
                // Set flag to indicate navigation came from dashboard
                sessionStorage.setItem('returnToDashboard', 'true');
                sessionStorage.setItem('dashboardUrl', window.location.href);
                
                // Don't trigger if clicking on the link itself
                if (e.target.tagName !== 'A') {
                    link.click();
                }
            });
        }
    });
    
    // Make entire Recommended items clickable with dashboard return flag
    document.querySelectorAll('.recommended-list-item').forEach(item => {
        const link = item.querySelector('.recommended-title');
        if (link) {
            item.style.cursor = 'pointer';
            item.addEventListener('click', function(e) {
                // Set flag to indicate navigation came from dashboard
                sessionStorage.setItem('returnToDashboard', 'true');
                sessionStorage.setItem('dashboardUrl', window.location.href);
                
                // Don't trigger if clicking on the link itself
                if (e.target.tagName !== 'A') {
                    link.click();
                }
            });
        }
    });
    
    // Handle back button behavior on other pages
    // This script should also run on quiz/resource/deck pages
    if (sessionStorage.getItem('returnToDashboard') === 'true') {
        // Override default back button behavior
        const backButtons = document.querySelectorAll('[onclick*="history.back()"], .btn-back, a[href*="javascript:history.back()"]');
        backButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const dashboardUrl = sessionStorage.getItem('dashboardUrl');
                sessionStorage.removeItem('returnToDashboard');
                sessionStorage.removeItem('dashboardUrl');
                window.location.href = dashboardUrl || "{% url 'accounts:student_dashboard' %}";
            });
        });
    }
});
</script>
{% endblock %}
