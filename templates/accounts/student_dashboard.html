{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block header %}
{% include 'components/page_header.html' with page_title="Welcome back, "|add:user.first_name|add:"!" page_subtitle=dashboard_date_str search_placeholder="Search..." %}
{% endblock %}

<!-- In-progress Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="inProgressToast" class="toast align-items-center text-bg-secondary border-0" role="status" aria-live="polite" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">This feature is in progress.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

{% block content %}
<!-- Stats Row (4 cards) -->
<div class="row g-3 mb-3">
    <div class="col-12 col-md-6 col-lg-6 col-xxl-3">
        <div class="stat-card stat-card-purple h-100">
            <div class="stat-icon"><i class="fas fa-folder"></i></div>
            <div class="stat-content">
                <div class="stat-label">Total Resources</div>
                <div class="stat-value" data-target="{{ total_resources }}">0</div>
                <div class="stat-sublabel">From your library</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-6 col-xxl-3">
        <div class="stat-card stat-card-green h-100">
            <div class="stat-icon"><i class="fas fa-question-circle"></i></div>
            <div class="stat-content">
                <div class="stat-label">Total Quizzes</div>
                <div class="stat-value" data-target="{{ total_quizzes_posted|default:0 }}">0</div>
                <div class="stat-sublabel">Available quizzes</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-6 col-xxl-3">
        <div class="stat-card stat-card-blue h-100">
            <div class="stat-icon"><i class="fas fa-bookmark"></i></div>
            <div class="stat-content">
                <div class="stat-label">Bookmarks</div>
                <div class="stat-value" data-target="{{ total_bookmarks }}">0</div>
                <div class="stat-sublabel">Saved for later</div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-6 col-xxl-3">
        <div class="stat-card stat-card-teal h-100">
            <div class="stat-icon"><i class="fas fa-clone"></i></div>
            <div class="stat-content">
                <div class="stat-label">Flashcard Decks</div>
                <div class="stat-value" data-target="{{ total_flashcard_decks|default:0 }}">0</div>
                <div class="stat-sublabel">Your study sets</div>
            </div>
        </div>
    </div>
</div>

<!-- Main Grid: Quick Actions (left) | Insights (center) | Latest Resources (right) -->
<div class="row g-3 align-items-start">
    <!-- Quick Actions -->
    <div class="col-12 col-lg-4 col-xl-3">
        <div class="card dashboard-card quick-actions-card equal-height">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body quick-actions-body">
                <div class="qa-grid">
                    <a class="qa-tile qa-green" href="{% url 'resources:resource_upload' %}" aria-label="Upload Resource">
                        <div class="qa-icon"><i class="fas fa-upload"></i></div>
                        <div class="qa-title">Upload</div>
                    </a>
                    <a class="qa-tile qa-amber" href="{% url 'resources:resource_list' %}" aria-label="Browse Library">
                        <div class="qa-icon"><i class="fas fa-book"></i></div>
                        <div class="qa-title">Library</div>
                    </a>
                    <a class="qa-tile qa-blue" href="{% url 'quizzes:quiz_create' %}" aria-label="Create Quiz">
                        <div class="qa-icon"><i class="fas fa-plus-circle"></i></div>
                        <div class="qa-title">Create Quiz</div>
                    </a>
                    <a class="qa-tile qa-purple" href="{% url 'flashcards:deck_list' %}" aria-label="Flashcards">
                        <div class="qa-icon"><i class="fas fa-clone"></i></div>
                        <div class="qa-title">Flashcards</div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Center -->
    <div class="col-12 col-lg-8 col-xl-6">
        <div class="card dashboard-card insights-card equal-height">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                    <h5 class="card-title mb-0">Learning Insights</h5>
                    <span class="badge bg-light text-dark small">Last 7 days</span>
                </div>
                <div class="metric-selector btn-group btn-group-sm" role="group" aria-label="Metric selector">
                    <input type="radio" class="btn-check" name="metricType" id="metricUploads" value="uploads" checked autocomplete="off">
                    <label class="btn metric-btn metric-uploads" for="metricUploads" title="Uploads"><span class="metric-dot uploads"></span>Uploads</label>
                    <input type="radio" class="btn-check" name="metricType" id="metricQuizzes" value="quizzes" autocomplete="off">
                    <label class="btn metric-btn metric-quizzes" for="metricQuizzes" title="Quizzes (Created vs Attempted)"><span class="metric-dot quizzes"></span>Quizzes</label>
                    <input type="radio" class="btn-check" name="metricType" id="metricDecks" value="decks" autocomplete="off">
                    <label class="btn metric-btn metric-flashcards" for="metricDecks" title="Decks (Cards Created vs Reviewed)"><span class="metric-dot flashcards"></span>Decks</label>
                    <input type="radio" class="btn-check" name="metricType" id="metricBookmarks" value="bookmarks" autocomplete="off">
                    <label class="btn metric-btn metric-activity" for="metricBookmarks" title="Bookmarks Activity"><span class="metric-dot activity"></span>Bookmarks</label>
                    <input type="radio" class="btn-check" name="metricType" id="metricAll" value="all" autocomplete="off">
                    <label class="btn metric-btn metric-all" for="metricAll" title="Show All"><span class="metric-dot multi"></span>All</label>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-wrap">
                    <canvas id="insightsChart" class="w-100" aria-label="Learning insights chart" role="img"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- New Uploads Sidebar -->
    <div class="col-12 col-xl-3">
    <div class="card dashboard-card latest-resources-card equal-height">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">New Uploads</h5>
                <a href="{% url 'resources:resource_list' %}" class="small text-decoration-none" style="color:#4f46e5;">View All</a>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0 small latest-resources-list {% if not new_uploads %}empty{% endif %}">
                    {% if new_uploads %}
                        {% for item in new_uploads %}
                            <li class="d-flex justify-content-between align-items-center mb-2 latest-resource-item">
                                <span class="text-truncate d-flex align-items-center gap-2" style="max-width:70%;">
                                    {% if item.type == 'resource' %}
                                        <i class="fas fa-file" style="color:#6b7280;" aria-hidden="true"></i>
                                    {% elif item.type == 'quiz' %}
                                        <i class="fas fa-question-circle" style="color:#6b7280;" aria-hidden="true"></i>
                                    {% elif item.type == 'flashcard' %}
                                        <i class="fas fa-clone" style="color:#6b7280;" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fas fa-file" style="color:#6b7280;" aria-hidden="true"></i>
                                    {% endif %}
                                    <a href="{{ item.url }}" class="text-decoration-none" style="color:#4f46e5;">{{ item.title|truncatechars:60 }}</a>
                                </span>
                                <span class="text-muted" style="font-size:0.7rem;">{{ item.created_at|date:'M d' }}</span>
                            </li>
                        {% endfor %}
                    {% else %}
                        <li class="text-muted">No recent uploads.</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Row: Recent Activity (left) | Calendar (right) -->
<div class="row g-3 mt-1">
    <div class="col-12 col-xl-7">
        <div class="card dashboard-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Activity</h5>
            </div>
            <div class="card-body p-0">
                <ul class="feed-list list-unstyled mb-0">
                    {% if activity_feed %}
                        {% for ev in activity_feed %}
                        <li class="feed-item">
                            <div class="feed-badge 
                                {% if ev.type == 'upload' or ev.type == 'flashcard_create' or ev.type == 'quiz_create' %}pdf
                                {% elif ev.type == 'rating' or ev.type == 'quiz_complete' %}quiz
                                {% elif ev.type == 'bookmark' or ev.type == 'flashcard_edit' or ev.type == 'card_create' %}note
                                {% else %}note{% endif %}">
                                <i class="fas fa-{% if ev.icon %}{{ ev.icon }}{% else %}info-circle{% endif %}"></i>
                            </div>
                            <div class="feed-content">
                                <div class="feed-title">{{ ev.title }}</div>
                                <div class="feed-meta">You â€¢ {{ ev.meta }}</div>
                            </div>
                        </li>
                        {% endfor %}
                    {% else %}
                        <li class="feed-item"><div class="feed-content"><div class="feed-title">No recent activity.</div><div class="feed-meta">Start uploading, creating flashcards, or rating resources.</div></div></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    <div class="col-12 col-xl-5">
        <div class="card dashboard-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Calendar</h5>
                <span class="text-muted small">{{ current_month_label }}</span>
            </div>
            <div class="card-body">
                <div class="calendar-grid" aria-label="Study calendar">
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>
                    {% for cell in calendar_cells %}
                        {% if cell.blank %}
                            <div class="calendar-day other-month"></div>
                        {% else %}
                            <div class="calendar-day {% if cell.is_today %}today{% endif %} {% if cell.events %}has-event{% endif %}" data-day="{{ cell.day }}" {% if cell.events %}data-event-count="{{ cell.events|length }}"{% endif %}>
                                {{ cell.day }}
                                {% if cell.is_today %}<span class="today-badge">Today</span>{% endif %}
                                {% if cell.events %}
                                    <div class="event-dot" title="{{ cell.events.0.title }}"></div>
                                    {% if cell.events|length > 1 %}<span class="event-count-badge">+{{ cell.events|length }}</span>{% endif %}
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Calendar Events Modal -->
<div class="modal fade" id="calendarEventsModal" tabindex="-1" aria-labelledby="calendarEventsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarEventsModalLabel">Day Events</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="list-unstyled mb-0 small" id="calendarEventsList"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<!-- Chart.js for the small insights bar chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{{ weekly_metrics|json_script:"weekly-metrics-data" }}
{{ calendar_events|json_script:"calendar-events-data" }}
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
