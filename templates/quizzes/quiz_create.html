{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz - PaperTrail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=4.5">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}?v=6.0">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=5.2">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" aria-label="Toggle Menu">
        <i class="fas fa-bars"></i>
    </button>

    <div class="sidebar-overlay"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-brand-toggle" id="sidebarToggle">
            <i class="fas fa-book-reader"></i>
            <span class="sidebar-text">PaperTrail</span>
        </div>

        <div class="sidebar-content">
            <nav class="sidebar-nav">
                <a href="{% url 'accounts:student_dashboard' %}" class="sidebar-item">
                    <i class="fas fa-home"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                <a href="{% url 'resources:resource_list' %}" class="sidebar-item">
                    <i class="fas fa-book"></i>
                    <span class="sidebar-text">Resources</span>
                </a>
                <a href="#" class="sidebar-item coming-soon" data-feature="coming-soon">
                    <i class="fas fa-bookmark"></i>
                    <span class="sidebar-text">Bookmarks</span>
                    <span class="coming-soon-badge">Soon</span>
                </a>
                <a href="#" class="sidebar-item coming-soon" data-feature="coming-soon">
                    <i class="fas fa-layer-group"></i>
                    <span class="sidebar-text">Flashcards</span>
                    <span class="coming-soon-badge">Soon</span>
                </a>
                <a href="{% url 'quizzes:quiz_list' %}" class="sidebar-item active">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="sidebar-text">Quizzes</span>
                </a>
                <a href="#" class="sidebar-item coming-soon" data-feature="coming-soon">
                    <i class="fas fa-comments"></i>
                    <span class="sidebar-text">Forum</span>
                    <span class="coming-soon-badge">Soon</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <a href="{% url 'accounts:profile' %}" class="sidebar-item">
                    <i class="fas fa-user"></i>
                    <span class="sidebar-text">Profile</span>
                </a>
                <a href="{% url 'accounts:settings' %}" class="sidebar-item">
                    <i class="fas fa-cog"></i>
                    <span class="sidebar-text">Settings</span>
                </a>
                <a href="{% url 'accounts:logout' %}" class="sidebar-item logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="sidebar-text">Sign Out</span>
                </a>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="dashboard-main">
            <div class="container-fluid">
                <div class="dashboard-header">
                    <div class="dashboard-title-section">
                        <h1 class="dashboard-title">Create Quiz</h1>
                        <p class="dashboard-date">Create a quiz to test knowledge</p>
                    </div>
                    <div class="dashboard-actions">
                        <a href="{% url 'quizzes:quiz_list' %}" class="btn" style="background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid rgba(102, 126, 234, 0.2); padding: 0.5rem 1.25rem; border-radius: 8px; font-weight: 600; text-decoration: none;">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </div>
                </div>

                {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                {% endif %}

                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <form method="post" id="quizCreateForm">
                            {% csrf_token %}
                            
                            <!-- Quiz Basic Info -->
                            <div class="card dashboard-card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-info-circle"></i> Quiz Information</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="{{ form.title.id_for_label }}" class="form-label">Quiz Title <span class="text-danger">*</span></label>
                                        {{ form.title }}
                                        {% if form.title.errors %}
                                            <div class="text-danger small">{{ form.title.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                                        {{ form.description }}
                                        {% if form.description.errors %}
                                            <div class="text-danger small">{{ form.description.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Questions Section -->
                            <div class="card dashboard-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0"><i class="fas fa-question-circle"></i> Questions</h5>
                                    <button type="button" class="btn btn-sm" id="addQuestionBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                                        <i class="fas fa-plus"></i> Add Question
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="questionsContainer">
                                        <!-- Questions will be added here dynamically -->
                                    </div>
                                    <div id="noQuestions" class="text-center py-4 text-muted">
                                        <i class="fas fa-question-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                        <p>No questions added yet. Click "Add Question" to get started.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden input for questions data -->
                            <input type="hidden" name="questions_data" id="questionsDataInput">

                            <!-- Submit Button -->
                            <div class="mt-4 text-end">
                                <button type="submit" class="btn btn-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 2rem; font-weight: 600;">
                                    <i class="fas fa-save"></i> Create Quiz
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/sidebar.js' %}?v=5.0"></script>
    <script>
        let questionCount = 0;

        document.getElementById('addQuestionBtn').addEventListener('click', function() {
            addQuestion();
        });

        function addQuestion() {
            questionCount++;
            const questionsContainer = document.getElementById('questionsContainer');
            const noQuestions = document.getElementById('noQuestions');
            noQuestions.style.display = 'none';

            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item mb-4 p-3 border rounded';
            questionDiv.id = `question-${questionCount}`;
            questionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0"><i class="fas fa-question"></i> Question ${questionCount}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${questionCount})">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Question Text <span class="text-danger">*</span></label>
                    <textarea class="form-control question-text" rows="3" placeholder="Enter your question here..." required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Question Type <span class="text-danger">*</span></label>
                    <select class="form-select question-type" onchange="toggleQuestionType(${questionCount})" required>
                        <option value="">Select type</option>
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="fill_in_blank">Fill in the Blank</option>
                    </select>
                </div>
                <div class="multiple-choice-options" style="display: none;">
                    <label class="form-label">Options <span class="text-danger">*</span></label>
                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <input type="text" class="form-control option-input" placeholder="Option 1" data-option="1">
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control option-input" placeholder="Option 2" data-option="2">
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <input type="text" class="form-control option-input" placeholder="Option 3" data-option="3">
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control option-input" placeholder="Option 4" data-option="4">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Correct Answer <span class="text-danger">*</span></label>
                    <input type="text" class="form-control correct-answer" placeholder="Enter correct answer" required>
                    <small class="text-muted">For multiple choice: enter the exact option text. For fill in blank: enter the answer.</small>
                </div>
            `;
            questionsContainer.appendChild(questionDiv);
        }

        function removeQuestion(id) {
            const questionDiv = document.getElementById(`question-${id}`);
            questionDiv.remove();
            updateQuestionNumbers();
            if (document.getElementById('questionsContainer').children.length === 0) {
                document.getElementById('noQuestions').style.display = 'block';
            }
        }

        function toggleQuestionType(questionId) {
            const questionDiv = document.getElementById(`question-${questionId}`);
            const questionType = questionDiv.querySelector('.question-type').value;
            const optionsDiv = questionDiv.querySelector('.multiple-choice-options');
            const correctAnswerInput = questionDiv.querySelector('.correct-answer');
            
            if (questionType === 'multiple_choice') {
                optionsDiv.style.display = 'block';
                correctAnswerInput.placeholder = 'Enter the exact option text that is correct';
            } else {
                optionsDiv.style.display = 'none';
                correctAnswerInput.placeholder = 'Enter correct answer';
            }
        }

        function updateQuestionNumbers() {
            const questions = document.querySelectorAll('.question-item');
            questions.forEach((q, index) => {
                const title = q.querySelector('h6');
                title.innerHTML = `<i class="fas fa-question"></i> Question ${index + 1}`;
            });
        }

        document.getElementById('quizCreateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const questions = [];
            const questionItems = document.querySelectorAll('.question-item');
            
            if (questionItems.length === 0) {
                alert('Please add at least one question.');
                return;
            }

            let isValid = true;
            questionItems.forEach((item, index) => {
                const questionText = item.querySelector('.question-text').value.trim();
                const questionType = item.querySelector('.question-type').value;
                const correctAnswer = item.querySelector('.correct-answer').value.trim();

                if (!questionText || !questionType || !correctAnswer) {
                    isValid = false;
                    return;
                }

                const questionData = {
                    question_text: questionText,
                    question_type: questionType,
                    correct_answer: correctAnswer
                };

                if (questionType === 'multiple_choice') {
                    const options = [];
                    item.querySelectorAll('.option-input').forEach(input => {
                        if (input.value.trim()) {
                            options.push(input.value.trim());
                        }
                    });
                    
                    if (options.length < 2) {
                        isValid = false;
                        alert(`Question ${index + 1}: Multiple choice questions need at least 2 options.`);
                        return;
                    }

                    questionData.option_1 = options[0] || '';
                    questionData.option_2 = options[1] || '';
                    questionData.option_3 = options[2] || '';
                    questionData.option_4 = options[3] || '';
                }

                questions.push(questionData);
            });

            if (!isValid) {
                alert('Please fill in all required fields for all questions.');
                return;
            }

            document.getElementById('questionsDataInput').value = JSON.stringify(questions);
            this.submit();
        });
    </script>
</body>
</html>

