{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}{{ quiz.title }}{% endblock %}

{% block extra_css %}<link rel="stylesheet" href="{% static 'css/resources.css' %}?v=1.1">{% endblock %}

{% block extra_js %}
<script src="{% static 'js/quiz_detail.js' %}?v=1.0"></script>
{% endblock %}

{% block header %}
{% url 'quizzes:quiz_list' as quizzes_url %}
{% include 'components/page_header.html' with page_title='Quiz Detail' back_url=quizzes_url show_moderate_btn=False %}
{% endblock %}

{% block content %}
<div class="resource-detail-container" data-quiz-id="{{ quiz.pk }}">
  
  <!-- Quiz Detail Grid Layout (4 boxes) -->
  <div class="resource-detail-grid-4">
    
    <!-- Top Left: Title, Description -->
    <div class="grid-item grid-resource-header">
      <div class="resource-info-card">
        <div class="resource-header-badges">
          <span class="resource-type-badge">QUIZ</span>
          {% if quiz.is_public %}
            {% if quiz.verification_status == 'verified' %}
              <span class="badge badge-verified badge-sm"><i class="fas fa-check-circle"></i> Verified</span>
            {% elif quiz.verification_status == 'pending' %}
              <span class="badge badge-pending badge-sm"><i class="fas fa-clock"></i> Pending</span>
            {% else %}
              <span class="badge bg-warning badge-sm"><i class="fas fa-eye-slash"></i> Not Verified</span>
            {% endif %}
          {% else %}
            <span class="badge bg-secondary badge-sm"><i class="fas fa-lock"></i> Private</span>
          {% endif %}
        </div>
        <h1 class="resource-title">{{ quiz.title }}</h1>
        {% if quiz.description %}
          <p class="resource-description">{{ quiz.description }}</p>
        {% else %}
          <p class="resource-description text-muted fst-italic">No description provided.</p>
        {% endif %}
      </div>
    </div>

    <!-- Top Right: Creator Profile -->
    <div class="grid-item grid-resource-uploader">
      <div class="uploader-card">
        <h3 class="uploader-card-title">Created by</h3>
        <a href="{% url 'accounts:public_profile' quiz.creator.username %}" class="uploader-profile-link">
          {% if quiz.creator.profile_picture %}
            <img src="{{ quiz.creator.profile_picture.url }}" class="uploader-avatar" alt="{{ quiz.creator.get_full_name }}">
          {% else %}
            <img src="https://ui-avatars.com/api/?name={{ quiz.creator.first_name }}+{{ quiz.creator.last_name }}&size=48&background=1f2937&color=fff" 
                 class="uploader-avatar" alt="{{ quiz.creator.get_full_name }}">
          {% endif %}
          <span class="uploader-name">{{ quiz.creator.get_full_name|default:quiz.creator.username }}</span>
        </a>
      </div>
    </div>

    <!-- Bottom Left: Stats -->
    <div class="grid-item grid-resource-stats">
      <div class="stats-card">
        <div class="stat-row">
          <span class="stat-label">Questions</span>
          <span class="stat-value">{{ quiz.total_questions }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Rating</span>
          <span class="stat-value">{{ quiz.get_average_rating|floatformat:1|default:"0.0" }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Likes</span>
          <span class="stat-value" id="likesStatValue">{{ quiz.likes.count|default:0 }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Created</span>
          <span class="stat-value">{{ quiz.created_at|date:"M d, Y" }}</span>
        </div>
        
        <!-- Best Score Badge (if attempted) -->
        {% if has_attempted %}
        <div class="mt-3 pt-3" style="border-top: 1px solid #e5e7eb;">
          <div class="d-flex align-items-center gap-2">
            <div style="font-size: 1.5rem; color: var(--color-secondary);">
              <i class="fas fa-medal"></i>
            </div>
            <div>
              <div style="font-size: 0.9rem; font-weight: 600; color: var(--color-primary);">Best Score: {{ best_attempt.score }}/{{ best_attempt.total_questions }}</div>
              <div class="text-muted" style="font-size: 0.75rem;">{{ best_attempt.percentage }}% - Already attempted</div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Bottom Right: Actions -->
    <div class="grid-item grid-resource-actions">
      <div class="actions-card">
        <h3 class="actions-title">Actions</h3>
        <div class="actions-list">
          
          <!-- Study Button (for both owner and non-owner) -->
          {% if quiz.total_questions > 0 %}
            <a href="{% url 'quizzes:quiz_attempt' quiz.pk %}" class="action-btn action-btn-primary">
              <i class="fas fa-play"></i>
              <span>Study</span>
            </a>
          {% else %}
            <button type="button" class="action-btn action-btn-primary" disabled title="No questions to study">
              <i class="fas fa-play"></i>
              <span>Study</span>
            </button>
          {% endif %}

          <!-- Preview Questions Button -->
          <button type="button" class="action-btn action-btn-secondary" data-bs-toggle="modal" data-bs-target="#previewQuestionsModal">
            <i class="fas fa-eye"></i>
            <span>Preview Questions</span>
          </button>

          {% if user.is_authenticated %}
            {% if user == quiz.creator %}
              {# Owner actions: Edit #}
              <button type="button" class="action-btn action-btn-edit" data-bs-toggle="modal" data-bs-target="#editQuizModal">
                <i class="fas fa-edit"></i>
                <span>Edit</span>
              </button>
            {% else %}
              {# Non-owner actions: Rate & Like #}
              <button type="button" class="action-btn action-btn-rating" data-bs-toggle="modal" data-bs-target="#ratingModal">
                <i class="fas fa-star"></i>
                <span>Rate Quiz</span>
              </button>
              
              <button type="button" class="action-btn action-btn-like" id="likeBtn" 
                      data-liked="{% if user_has_liked %}true{% else %}false{% endif %}"
                      data-like-url="{% url 'quizzes:like_toggle' quiz.pk %}">
                {% if user_has_liked %}
                  <i class="fas fa-heart"></i>
                  <span>Liked</span>
                {% else %}
                  <i class="far fa-heart"></i>
                  <span>Like</span>
                {% endif %}
              </button>
            {% endif %}

            {# Bookmark button for all users #}
            <form method="post" action="{% url 'quizzes:toggle_quiz_bookmark' quiz.pk %}" class="w-100">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="action-btn action-btn-bookmark">
                {% if is_bookmarked %}
                  <i class="fas fa-bookmark"></i>
                  <span>Bookmarked</span>
                {% else %}
                  <i class="far fa-bookmark"></i>
                  <span>Bookmark</span>
                {% endif %}
              </button>
            </form>
          {% endif %}
          
        </div>
      </div>
    </div>
    
  </div>

  <!-- Comment Section: Show only if quiz is public OR user is not the creator -->
  {% if quiz.is_public or user != quiz.creator %}
    {% include 'components/comment_section.html' with comments=comments user=user comment_url=comment_url delete_url_name='quizzes:delete_quiz_comment' current_user=user %}
  {% endif %}

</div>

<!-- Preview Questions Modal -->
<div class="modal fade" id="previewQuestionsModal" tabindex="-1" aria-labelledby="previewQuestionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewQuestionsModalLabel">Preview Questions ({{ quiz.total_questions }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height: 500px; overflow-y: auto; padding: 1.5rem;">
        {% if quiz.questions.all %}
          {% for question in quiz.questions.all %}
            <div class="card mb-4" style="border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div class="card-body" style="padding: 1.5rem;">
                <div class="row g-4">
                  <!-- Left Column: Question -->
                  <div class="col-md-6" style="border-right: 1px solid #e5e7eb;">
                    <h5 class="mb-3" style="font-weight: 700; color: #111827; font-size: 1.25rem;">Question {{ forloop.counter }}</h5>
                    <p class="mb-0" style="color: #374151; line-height: 1.6; font-size: 0.95rem;">{{ question.question_text }}</p>
                  </div>
                  
                  <!-- Right Column: Options -->
                  <div class="col-md-6">
                    <h5 class="mb-3" style="font-weight: 700; color: #111827; font-size: 1.25rem;">Options</h5>
                    {% if question.question_type == 'multiple_choice' %}
                      <div class="d-flex flex-wrap gap-3">
                        {% for option in question.options.all %}
                          <div class="flex-fill" style="min-width: 45%;">
                            <div class="p-2 text-center" style="background: #f3f4f6; border-radius: 6px; font-size: 0.85rem; color: #374151; font-weight: 500;">
                              {{ option.option_text|upper }}
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div class="p-2 text-center" style="background: #f3f4f6; border-radius: 6px; font-size: 0.85rem; color: #374151; font-weight: 500;">
                        {{ question.correct_answer|upper }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted text-center py-4">No questions added yet.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Rating Modal -->
{% include 'components/rating_modal.html' with rate_url=rate_url modal_id='ratingModal' item_type='Quiz' %}

<!-- Edit Quiz Modal -->
{% if user == quiz.creator %}
<div class="modal fade" id="editQuizModal" tabindex="-1" aria-labelledby="editQuizModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editQuizModalLabel">Edit Quiz</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editQuizForm" data-quiz-id="{{ quiz.pk }}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="editQuizTitle" class="form-label">Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editQuizTitle" name="title" value="{{ quiz.title }}" required>
          </div>
          <div class="mb-3">
            <label for="editQuizDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editQuizDescription" name="description" rows="3">{{ quiz.description }}</textarea>
          </div>
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="editQuizVisibility" name="is_public" {% if quiz.is_public %}checked{% endif %}>
              <label class="form-check-label" for="editQuizVisibility">
                Make this quiz public
              </label>
            </div>
            <small class="text-muted">
              {% if user.is_professor %}
                Public quizzes are automatically verified for professors.
              {% else %}
                Public quizzes require verification. Private quizzes are only visible to you.
              {% endif %}
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}